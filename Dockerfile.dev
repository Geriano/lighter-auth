# =============================================================================
# Development Dockerfile for lighter-auth
# =============================================================================
# Features:
# - Hot-reload support with cargo-watch
# - Volume mounts for source code (fast iteration)
# - Debug symbols enabled
# - Layer caching for fast rebuilds
# =============================================================================

FROM rust:1.90-slim-bookworm

# Install dependencies for building and hot-reload
RUN apt-get update && apt-get install -y \
  # Build dependencies
  pkg-config \
  libssl-dev \
  libpq-dev \
  curl \
  ca-certificates \
  # Hot-reload tool
  && cargo install cargo-watch \
  # Cleanup
  && apt-get clean \
  && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Copy dependency manifests first for layer caching
# This layer is only rebuilt when dependencies change
COPY Cargo.toml Cargo.lock ./
COPY migration/Cargo.toml ./migration/

# Create dummy source files to build dependencies
# This creates a cache layer with all dependencies compiled
RUN mkdir src && \
  echo "fn main() {}" > src/main.rs && \
  mkdir -p migration/src && \
  echo "fn main() {}" > migration/src/main.rs && \
  echo "" > migration/src/lib.rs && \
  # Build dependencies only (cache layer)
  cargo build --features postgres && \
  # Clean up dummy files
  rm -rf src migration/src

# Copy source code (this layer changes frequently)
# Previous layers are cached, so only this rebuilds on code changes
COPY . .

# Expose HTTP port
EXPOSE 8080

# Default command: run with hot-reload
# cargo-watch rebuilds and restarts on file changes
CMD ["cargo", "watch", "-x", "run --features postgres"]

# Alternative commands:
# - Run without hot-reload: cargo run --features postgres
# - Run tests: cargo test --features postgres
# - Run migrations: cargo run --manifest-path migration/Cargo.toml
